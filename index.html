<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B√°o C√°o Doanh Thu C∆°m N·∫•m Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');
        
        body {
            background-color: #f3f4f6;
            font-family: 'Quicksand', sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        
        #capture-area {
            background: #ffffff;
            padding: 35px 20px;
            color: #1f2937;
            min-width: 360px;
        }
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px dashed #e5e7eb;
            padding-bottom: 20px;
        }
        .report-title {
            font-size: 1.4rem;
            font-weight: 800;
            color: #111827;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .report-row {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .col-name { flex: 1; min-width: 0; padding-right: 10px; }
        .col-qty { width: 125px; flex-shrink: 0; display: flex; justify-content: center; }
        .col-price { width: 95px; flex-shrink: 0; text-align: right; }

        .qty-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .qty-box { width: 32px; text-align: center; font-weight: 700; font-size: 14px; }
        .qty-sep { width: 12px; text-align: center; color: #cbd5e1; font-size: 12px; }
        .qty-in { color: #94a3b8; font-weight: 500; }
        .qty-sold { color: #111827; font-weight: 800; font-size: 15px; }
        .qty-rem { color: #f97316; }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }
        .summary-value {
            font-weight: 700;
            margin-left: 20px;
        }

        .final-cash-box {
            margin-top: 25px;
            background: #f0fdf4;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #dcfce7;
            text-align: center;
        }
        .final-cash-amount {
            font-size: 32px;
            font-weight: 900;
            color: #166534;
            display: block;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex justify-center pb-24">
    <div class="w-full max-w-lg">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 tracking-tight">C∆†M N·∫§M <span class="text-orange-500">PRO</span></h1>
            <p class="text-gray-400 text-sm">Qu·∫£n l√Ω b√°n h√†ng tinh g·ªçn</p>
        </div>

        <!-- Nh·∫≠p li·ªáu -->
        <div class="card p-6 mb-6 space-y-4">
            <h2 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-2">Th√¥ng tin ca l√†m</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Chi nh√°nh</label>
                    <input type="text" id="branch" oninput="saveCurrentState()" class="w-full p-3 border border-gray-100 bg-gray-50 rounded-xl outline-none" value="CN8">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Bu·ªïi b√°n</label>
                    <input type="text" id="shift" oninput="saveCurrentState()" class="w-full p-3 border border-gray-100 bg-gray-50 rounded-xl outline-none">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-blue-500 uppercase mb-1">Ti·ªÅn k√©t ƒë·∫ßu (ƒë)</label>
                    <input type="number" id="cashBox" oninput="saveCurrentState()" class="w-full p-3 border border-blue-50 bg-blue-50/30 rounded-xl font-bold text-blue-700 outline-none" value="260000">
                </div>
                <div>
                    <label class="block text-xs font-bold text-purple-500 uppercase mb-1">Chuy·ªÉn kho·∫£n (ƒë)</label>
                    <input type="number" id="bankTransfer" oninput="saveCurrentState()" class="w-full p-3 border border-purple-50 bg-purple-50/30 rounded-xl font-bold text-purple-700 outline-none" value="0">
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-red-500 uppercase mb-1">Chi ph√≠ ph√°t sinh (ƒë)</label>
                <input type="number" id="totalExpense" oninput="saveCurrentState()" class="w-full p-3 border border-red-50 bg-red-50/30 rounded-xl font-bold text-red-700 outline-none" value="0">
            </div>
        </div>

        <!-- Danh s√°ch nh·∫≠p s·ªë l∆∞·ª£ng -->
        <div class="card p-6 mb-6">
            <h2 class="font-bold text-gray-800 uppercase text-xs mb-4 border-b pb-2">S·ªë l∆∞·ª£ng b√°n h√†ng</h2>
            <div id="product-container" class="space-y-4"></div>
        </div>

        <!-- C·ª•m n√∫t h√†nh ƒë·ªông -->
        <div class="grid grid-cols-3 gap-3 mb-10">
            <button onclick="calculateAndDisplay()" class="col-span-2 bg-gray-900 text-white font-bold py-5 rounded-2xl shadow-xl active:scale-95 transition-all text-lg">
                XU·∫§T B√ÅO C√ÅO üìä
            </button>
            <button onclick="resetForNewDay()" class="col-span-1 bg-white border-2 border-red-100 text-red-500 font-bold py-5 rounded-2xl shadow-sm active:scale-95 transition-all text-sm uppercase">
                X√≥a d·ªØ li·ªáu
            </button>
        </div>

        <!-- B√ÅO C√ÅO HI·ªÇN TH·ªä -->
        <div id="report-section" class="hidden animate-in fade-in duration-500">
            <div id="capture-area" class="card shadow-none border border-gray-100 mb-4">
                <div class="report-header">
                    <h3 class="report-title">B√ÅO C√ÅO DOANH THU</h3>
                    <div id="res-info" class="report-info text-sm"></div>
                </div>
                
                <div class="flex justify-between text-[10px] font-bold text-gray-400 uppercase mb-2 px-1">
                    <span class="flex-1 text-left">M√≥n</span>
                    <span class="w-[125px] text-center">Nh·∫≠p / B√°n / D∆∞</span>
                    <span class="w-[95px] text-right">Ti·ªÅn</span>
                </div>

                <div id="res-body"></div>

                <div class="mt-8 pt-6 border-t-2 border-gray-50 space-y-2">
                    <div class="summary-item">
                        <span class="text-xs font-bold text-blue-600 uppercase">T·ªïng doanh thu:</span>
                        <span id="res-revenue" class="text-blue-600 font-black text-xl">0ƒë</span>
                    </div>
                    <div class="summary-item text-gray-500 text-sm">
                        <span>Ti·ªÅn k√©t ƒë·∫ßu bu·ªïi (+):</span>
                        <span id="res-cashbox-view" class="summary-value">0ƒë</span>
                    </div>
                    <div class="summary-item text-purple-600 text-sm">
                        <span>Chuy·ªÉn kho·∫£n (-):</span>
                        <span id="res-transfer" class="summary-value">0ƒë</span>
                    </div>
                    <div class="summary-item text-red-500 text-sm font-semibold">
                        <span>Chi ph√≠ ph√°t sinh (-):</span>
                        <span id="res-expense" class="summary-value">0ƒë</span>
                    </div>
                    
                    <div class="final-cash-box">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest block mb-1">Th·ª±c thu ti·ªÅn m·∫∑t</span>
                        <span id="res-cash" class="final-cash-amount">0ƒë</span>
                    </div>
                </div>
                
                <div class="mt-10 flex justify-between items-center text-[9px] text-gray-300 font-bold uppercase tracking-widest">
                    <span>C∆°m N·∫•m Pro v3.1</span>
                    <span id="res-time"></span>
                </div>
            </div>

            <button onclick="downloadImage()" class="w-full bg-emerald-500 text-white font-bold py-5 rounded-xl shadow-lg mb-20 text-lg">
                üíæ T·∫¢I ·∫¢NH B√ÅO C√ÅO
            </button>
        </div>
    </div>

    <script>
        const products = [
            { id: 'ca-hoi', name: 'C∆°m n·∫Øm c√° h·ªìi', price: 22000 },
            { id: 'ga-mayo', name: 'C∆°m n·∫Øm g√† mayo', price: 18000 },
            { id: 'ga-phomai', name: 'C∆°m n·∫Øm g√† ph√¥ mai', price: 22000 },
            { id: 'bo-ham', name: 'C∆°m n·∫Øm b√≤ h·∫ßm', price: 23000 },
            { id: 'trung-chabong', name: 'C∆°m n·∫Øm tr·ª©ng tr√† b√¥ng', price: 16000 },
            { id: 'ca-ngu', name: 'C∆°m n·∫Øm c√° ng·ª´', price: 20000 }
        ];

        let state = {};

        function getToday() {
            const d = new Date();
            return `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
        }

        function formatMoney(num) {
            return num.toLocaleString('vi-VN') + 'ƒë';
        }

        // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i v√†o localStorage
        function saveCurrentState() {
            const data = {
                branch: document.getElementById('branch').value,
                shift: document.getElementById('shift').value,
                cashBox: document.getElementById('cashBox').value,
                bankTransfer: document.getElementById('bankTransfer').value,
                totalExpense: document.getElementById('totalExpense').value,
                state: state
            };
            localStorage.setItem('com_nam_current_v3', JSON.stringify(data));
        }

        // Reset d·ªØ li·ªáu (X√≥a s·∫°ch s·ªë l∆∞·ª£ng)
        function resetForNewDay() {
            const isConfirmed = confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA H·∫æT s·ªë l∆∞·ª£ng ƒëang nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu ca m·ªõi kh√¥ng?");
            if (isConfirmed) {
                products.forEach(p => {
                    state[p.id] = { stock: 0, sold: 0 };
                });
                // X√≥a c·∫£ trong storage ngo·∫°i tr·ª´ t√™n chi nh√°nh n·∫øu mu·ªën gi·ªØ l·∫°i
                const branch = document.getElementById('branch').value;
                localStorage.removeItem('com_nam_current_v3');
                
                // Kh·ªüi t·∫°o l·∫°i tr·∫°ng th√°i m·∫∑c ƒë·ªãnh
                document.getElementById('shift').value = "S√°ng " + getToday();
                document.getElementById('bankTransfer').value = 0;
                document.getElementById('totalExpense').value = 0;
                
                saveCurrentState();
                location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ reset to√†n b·ªô UI
            }
        }

        function init() {
            // T·∫£i tr·∫°ng th√°i ƒë√£ l∆∞u
            const savedCurrent = localStorage.getItem('com_nam_current_v3');
            let currentData = {};
            if(savedCurrent) currentData = JSON.parse(savedCurrent);

            document.getElementById('branch').value = currentData.branch || "CN8";
            document.getElementById('shift').value = currentData.shift || ("S√°ng " + getToday());
            document.getElementById('cashBox').value = currentData.cashBox || "260000";
            document.getElementById('bankTransfer').value = currentData.bankTransfer || "0";
            document.getElementById('totalExpense').value = currentData.totalExpense || "0";
            state = currentData.state || {};

            const container = document.getElementById('product-container');
            products.forEach(p => {
                if (!state[p.id]) state[p.id] = { stock: 0, sold: 0 };
                
                const div = document.createElement('div');
                div.className = "flex items-center justify-between bg-gray-50/50 p-3 rounded-xl border border-gray-50";
                div.innerHTML = `
                    <div class="flex-1">
                        <p class="font-bold text-gray-800 text-sm">${p.name}</p>
                        <p class="text-[10px] font-bold text-gray-400">${p.price.toLocaleString()}ƒë</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex flex-col items-center">
                           <span class="text-[8px] font-bold text-gray-400 uppercase mb-1">Nh·∫≠p</span>
                           <input type="number" oninput="updateStock('${p.id}', this.value)" id="input-stock-${p.id}"
                               class="w-10 p-1 text-center border-b-2 border-gray-200 focus:border-orange-400 outline-none font-bold text-sm bg-transparent" 
                               value="${state[p.id].stock || ''}" placeholder="0">
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-[8px] font-bold text-gray-400 uppercase mb-1">B√°n</span>
                            <div class="flex items-center gap-2 bg-white p-1 rounded-lg shadow-sm border border-gray-100">
                                <button onclick="updateSold('${p.id}', -1)" class="w-7 h-7 bg-red-500 text-white rounded-md font-bold">-</button>
                                <span id="sold-${p.id}" class="w-5 text-center font-bold text-sm text-gray-700">${state[p.id].sold}</span>
                                <button onclick="updateSold('${p.id}', 1)" class="w-7 h-7 bg-emerald-500 text-white rounded-md font-bold">+</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateStock(id, val) { 
            state[id].stock = parseInt(val) || 0; 
            saveCurrentState();
        }
        
        function updateSold(id, delta) {
            state[id].sold = Math.max(0, state[id].sold + delta);
            document.getElementById(`sold-${id}`).innerText = state[id].sold;
            saveCurrentState();
        }

        function calculateAndDisplay() {
            let totalRevenue = 0;
            const resBody = document.getElementById('res-body');
            const branch = document.getElementById('branch').value;
            const shift = document.getElementById('shift').value;
            const cashBox = parseInt(document.getElementById('cashBox').value) || 0;
            const bank = parseInt(document.getElementById('bankTransfer').value) || 0;
            const exp = parseInt(document.getElementById('totalExpense').value) || 0;
            const timeStr = new Date().toLocaleTimeString('vi-VN') + ' ' + getToday();
            
            resBody.innerHTML = '';
            
            products.forEach(p => {
                const { stock, sold } = state[p.id];
                const remain = Math.max(0, stock - sold);
                const subtotal = sold * p.price;
                totalRevenue += subtotal;

                if(stock > 0 || sold > 0) {
                    const row = document.createElement('div');
                    row.className = "report-row";
                    row.innerHTML = `
                        <div class="col-name font-semibold text-gray-700 text-[13px]">${p.name}</div>
                        <div class="col-qty">
                            <div class="qty-container">
                                <div class="qty-box qty-in">${stock}</div>
                                <div class="qty-sep">/</div>
                                <div class="qty-box qty-sold">${sold}</div>
                                <div class="qty-sep">/</div>
                                <div class="qty-box qty-rem">${remain}</div>
                            </div>
                        </div>
                        <div class="col-price font-bold text-gray-900 text-[14px]">${formatMoney(subtotal)}</div>
                    `;
                    resBody.appendChild(row);
                }
            });

            const finalCash = (totalRevenue + cashBox) - bank - exp;

            document.getElementById('res-info').innerText = `${branch} | ${shift}`;
            document.getElementById('res-revenue').innerText = formatMoney(totalRevenue);
            document.getElementById('res-cashbox-view').innerText = formatMoney(cashBox);
            document.getElementById('res-transfer').innerText = formatMoney(bank);
            document.getElementById('res-expense').innerText = formatMoney(exp);
            document.getElementById('res-time').innerText = timeStr;
            document.getElementById('res-cash').innerText = formatMoney(finalCash);

            document.getElementById('report-section').classList.remove('hidden');
            window.scrollTo({ top: document.getElementById('report-section').offsetTop - 20, behavior: 'smooth' });
        }

        async function downloadImage() {
            const el = document.getElementById('capture-area');
            const canvas = await html2canvas(el, { 
                scale: 3, 
                backgroundColor: "#ffffff",
                useCORS: true 
            });
            const link = document.createElement('a');
            link.download = `BaoCao_${document.getElementById('branch').value}_${getToday().replace(/\//g,'-')}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        }

        window.onload = init;
    </script>
</body>
</html>
